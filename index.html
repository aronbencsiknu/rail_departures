<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Hitchin Live Departures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="railway-station.png">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Next:ital,wght@0,200..800;1,200..800&display=swap');

    :root {
      --bg: #f4f4f6;
      --card-bg: #ffffff;
      --text: #1a1a1a;
      --accent: #0019a8;
      --border: #d4d4db;
      --row-alt: #fafafa;

      --on-time: #0b8f52;
      --delayed: #ffa600;
      --cancelled: #b81414;
    }

    body {
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text);
      font-family: "Atkinson Hyperlegible Next", sans-serif;
      display: flex;
      justify-content: center;
      line-height: 1.5;
    }

    header {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
    }

    h1 {
      font-size: 1.6rem;
      padding: 0;
      font-weight: 600;
      color: var(--accent);
      margin: 5px 0 30px 5px;
    }

    #clock {
      color: var(--accent);
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0 5px 30px 0;
      width: 103px;
    }
    #clock span {
      font-size: 2rem;
      font-weight: 800;
    }

    .card {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
    }

    .station-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .station-buttons button {
      background: #fff;
      border: 1px solid var(--border);
      padding: 8px 14px;
      font-size: 0.95rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.15s;
      flex: 1 1 auto;
      min-width: 100px;
      text-align: center;
    }

    .station-buttons button:hover {
      background: #ececf1;
    }

    .station-buttons button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    /* ------------------------------ */
    /* RESPONSIVE GRID TABLE          */
    /* ------------------------------ */

    .departures-grid {
      display: grid;
      grid-template-columns: 120px 1fr 100px 120px;
      gap: 0;
      align-items: center;
      width: 100%;
      margin-top: 10px;
    }

    .departures-grid-header {
      font-weight: 700;
      border-bottom: 2px solid var(--border);
      padding-bottom: 6px;
    }

    .departures-row {
      display: contents;
    }

    .departures-cell {
      /* padding: 10px 4px; */
      display: flex;
      border-bottom: 1px solid #e3e3ea;
      height: 50px;
      align-items: center;
    }

    .status {
      padding: 4px 10px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 0.85rem;
      color: #fff;
      display: inline-block;
    }
    .on-time { background: var(--on-time);}
    .delayed { background: var(--delayed); color:black;}
    .cancelled { background: var(--cancelled); }

    .loading, .error {
      padding: 16px;
      text-align: center;
      font-size: 1rem;
      color: var(--accent);
    }
    .rail-logo { 
    width: 60px;                /* change size as needed */
    height: 50px;               /* keep aspect ratio by adjusting both */
    background-color: var(--accent);
    margin-left: 10px;
    /* center and contain the SVG mask */
    -webkit-mask: url("https://upload.wikimedia.org/wikipedia/commons/3/31/National_Rail_logo.svg") center / contain no-repeat;
    mask: url("https://upload.wikimedia.org/wikipedia/commons/3/31/National_Rail_logo.svg") center / contain no-repeat;
    /* ensure high-contrast fallback if masks not supported */
    background-repeat: no-repeat;
    display: inline-block;
  }

    /* MOBILE CARD VIEW */
    @media (max-width: 600px) {
      .departures-grid {
        display: block;
      }

      .departures-grid-header {
        display: none;
      }

      .departures-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        margin-bottom: 10px;
        gap: 6px;
      }

      .departures-cell {
        display: block;
        border-bottom: none;
        padding: 2px 0;
      }
      .departures-row .departures-cell:nth-child(1){
        font-weight: 600;
      }
      .departures-row .departures-cell:nth-last-child(1){
        font-size: 0.9rem;
      }

      .departures-cell::before {
        content: attr(data-label);
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--accent);
        display: block;
        margin-bottom: 2px;
        text-transform: uppercase;
      }

      .card {
        border: none;
      }
      body {
        padding: 0;
      }
      
    }

  </style>
</head>
<body>

<div class="card" role="region" aria-label="Live train departures">
  <header>
    <div class="rail-logo" role="img" aria-label="National Rail logo"></div>
    <div id="clock"></div>
  </header>

  <div class="station-buttons">
    <button data-station="SVG">Stevenage</button>
    <button data-station="LWG">Letchworth</button>
    <button data-station="LONDON">London</button>
  </div>

  <!-- Replaces the old table -->
  <div id="departures-grid" class="departures-grid">
    <div class="loading">Loading live data…</div>
  </div>
</div>

<script>
  let currentStation = "LONDON";

  const stationSets = {
    "SVG": { "SVG": "Stevenage" },
    "LWG": { "LET": "Letchworth" },
    "LONDON": {
      "STP": "London St Pancras",
      "KGX": "London Kings Cross"
    }
  };

  function startTime() {
    const today = new Date();
    let h = today.getHours();
    let m = today.getMinutes();
    let s = today.getSeconds();
    m = m < 10 ? "0" + m : m;
    s = s < 10 ? "0" + s : s;
    document.getElementById('clock').innerHTML = "<span>" + h + ":" + m + "</span>" + s;
    setTimeout(startTime, 1000);
  }

  async function loadDepartures() {
    const grid = document.getElementById("departures-grid");
    try {
      let allServices = [];
      const stations = stationSets[currentStation];

      for (const code of Object.keys(stations)) {
        const res = await fetch(`https://huxley2.azurewebsites.net/departures/HIT/to/${code}/30`);
        const json = await res.json();

        if (json.trainServices) {
          const services = json.trainServices.map(s => ({
            ...s,
            destinationName: stations[code]
          }));
          allServices = allServices.concat(services);
        }
      }

      allServices.sort((a, b) => a.std.localeCompare(b.std));

      if (!allServices.length) {
        grid.innerHTML = `<div class="error">No live services available.</div>`;
        return;
      }

      grid.innerHTML = `
        <div class="departures-grid-header">Time</div>
        <div class="departures-grid-header">Destination</div>
        <div class="departures-grid-header">Status</div>
        <div class="departures-grid-header">Operator</div>
      `;

      grid.innerHTML += allServices.slice(0, 40).map(s => {
        const etd = s.etd.toLowerCase();
        const cls = etd.includes("cancel") ? "cancelled" :
                    etd.includes("on time") ? "on-time" :
                    "delayed";

        return `
          <div class="departures-row">
            <div class="departures-cell" data-label="Time">${s.std}</div>
            <div class="departures-cell" data-label="Destination">${s.destinationName}</div>
            <div class="departures-cell" data-label="Status">
              <span class="status ${cls}">${s.etd}</span>
            </div>
            <div class="departures-cell" data-label="Operator">${s.operator}</div>
          </div>
        `;
      }).join('');

    } catch (e) {
      grid.innerHTML = `<div class="error">Error loading data</div>`;
    }
  }

  document.querySelectorAll(".station-buttons button").forEach(btn => {
    btn.addEventListener("click", () => {
        const grid = document.getElementById("departures-grid");
        grid.innerHTML = `<div class="loading">Loading live data…</div>`;
      document.querySelectorAll(".station-buttons button")
        .forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentStation = btn.dataset.station;
      loadDepartures();
    });
  });

  window.addEventListener('DOMContentLoaded', () => {
    document.querySelector('[data-station="LONDON"]').classList.add("active");
    loadDepartures();
    setInterval(loadDepartures, 30000);
    startTime();
  });
</script>

</body>
</html>
